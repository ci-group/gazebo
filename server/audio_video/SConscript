#Import variable
Import('env sharedObjs headers install_prefix')

parseConfigs = [
  'pkg-config --cflags --libs libavformat',
  'pkg-config --cflags --libs libavcodec',
  'pkg-config --cflags --libs openal'
]

myEnv = env.Clone()

sources = ['AudioDecoder.cc', 
           'OpenAL.cc'
           ]

headers.append( 
          ['server/audio_video/AudioDecoder.hh',
           'server/audio_video/OpenAL.hh',
           ] )

enable_openal = 1


#
# Parse all the pacakge configurations
#
if not myEnv.GetOption('clean'):
  for cfg in parseConfigs:
    print "Checking for ["+cfg+"]"
    try:
      myEnv.ParseConfig(cfg)
      print "  Success"
    except OSError,e:
      print "Unable to parse config ["+cfg+"]"
      if cfg.find("OpenAL") >= 0:
        print "OpenAL not found. 3D audio is disabled."
        print "  http://connect.creativelabs.com/"
        enable_openal = 0
      if cfg.find("avcodec") >= 0 or cfg.find("avformat") >= 0:
        print "FFMpeg not found. Audio decoding disabled."
        print "  http://ffmpeg.mplayerhq.hu/"
        enable_openal = 0

conf = Configure(myEnv)
if conf.CheckLib('openal'):
  conf.env.Append(CCFLAGS = " -DENABLE_OPENAL")
myEnv = conf.Finish()

sharedLib = myEnv.SharedLibrary('gazeboav', sources)
myEnv.Install(install_prefix+'/lib', sharedLib)

